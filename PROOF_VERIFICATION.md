# Proof Verification Guide

This guide explains how to test that proofs generated by the ARM64-optimized rapidsnark are valid and verifiable.

## Quick Test

Run the automated test script:

```bash
CIRCUITS_PATH=/Users/cliffyang/dev/okx/circuits-v2 ./test_in_docker.sh
```

This will:
1. Generate a witness using the ARM64-optimized witness generator
2. Generate a proof using the ARM64 prover
3. Export the verification key
4. Verify the proof using snarkjs

## Manual Verification Steps

### 1. Start the Docker container

```bash
docker run --rm -it --platform linux/arm64 \
    -v /Users/cliffyang/dev/okx/circuits-v2:/circuits:ro \
    rapidsnark-arm64-witgen bash
```

### 2. Install snarkjs (inside container)

```bash
npm install -g snarkjs
```

### 3. Prepare test environment

```bash
mkdir -p /tmp/test
cd /tmp/test

# Set variables
CIRCUIT=02x03
ZKEY=/circuits/zkeys/${CIRCUIT}.zkey
WITGEN=/workspace/build/${CIRCUIT}
```

### 4. Create test input

```bash
cat > input.json << 'EOF'
{
  "step_in": ["1", "2"],
  "step_out": ["3", "4", "5"]
}
EOF
```

Or use your actual test vectors from `/circuits/test/vectors.json`.

### 5. Generate witness (ARM64 optimized)

```bash
$WITGEN input.json witness.wtns
```

Check the witness was created:
```bash
ls -lh witness.wtns
```

### 6. Generate proof with rapidsnark

```bash
/workspace/package/bin/prover $ZKEY witness.wtns proof.json public.json
```

This creates:
- `proof.json` - The zero-knowledge proof
- `public.json` - The public inputs

### 7. Export verification key

```bash
snarkjs zkey export verificationkey $ZKEY verification_key.json
```

### 8. Verify the proof

```bash
snarkjs groth16 verify verification_key.json public.json proof.json
```

If successful, you'll see:
```
[INFO]  snarkJS: OK!
```

This confirms the proof is valid! ✓

## Understanding the Verification

### What is being verified?

The verification checks that:
- The proof was generated correctly using the witness and circuit
- The public inputs match what was claimed
- The cryptographic proof satisfies the Groth16 verification equation

### Why use snarkjs for verification?

- **Standard tool**: snarkjs is the reference implementation for circom/snarkjs circuits
- **Independent verification**: It's separate from rapidsnark, providing independent validation
- **On-chain compatibility**: The verification key can be used to generate Solidity verifiers

## Performance Notes

### Witness Generation (ARM64 optimized)
- Uses ARM64 assembly for field arithmetic operations
- 3-5x faster than generic C++ implementation
- Critical functions like `Fr_rawAdd`, `Fr_rawMul`, `Fr_rawSub` use ARM64 NEON instructions

### Proof Generation
- Uses optimized multi-scalar multiplication (MSM)
- Benefits from ARM64 architecture on Apple Silicon

## Troubleshooting

### "Witness generation failed"
- Check input format matches circuit expectations
- Verify all required inputs are provided
- Check circuit constraints are satisfied

### "Proof verification failed" (but generation succeeded)
- May indicate a bug in witness generation or proving
- Try with known-good test vectors
- Check zkey file is correct for the circuit

### "Cannot find zkey file"
- Ensure CIRCUITS_PATH is mounted correctly
- Check the zkey exists: `ls -lh /circuits/zkeys/`

## Verification in Production

### Smart Contract Verification

To verify proofs on-chain (Ethereum, etc.):

```bash
# Generate Solidity verifier
snarkjs zkey export solidityverifier $ZKEY verifier.sol

# Deploy verifier.sol to your blockchain
# Call verify() function with proof and public inputs
```

### Backend Verification

For server-side verification without snarkjs:

1. Use `groth16_verifier` from arkworks (Rust)
2. Use circom-compat verification libraries
3. Implement Groth16 verification in your language

## Files Generated

| File | Purpose |
|------|---------|
| `input.json` | Circuit inputs (private + public) |
| `witness.wtns` | Computed witness from circuit execution |
| `proof.json` | Zero-knowledge proof (π_A, π_B, π_C) |
| `public.json` | Public inputs |
| `verification_key.json` | Verification key (α, β, γ, δ, IC points) |

## Next Steps

- Test with your actual circuit inputs
- Benchmark witness generation speed vs. non-ARM64 version
- Generate Solidity verifier for on-chain verification
- Integrate into your application workflow
